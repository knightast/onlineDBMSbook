# 文档的存储

文档数据库的数据存取功能看似简单。但要高效可靠地实现这些功能却并不简单，必须依靠精巧的技术手段。为了掌握好数据库的使用方法，读者需要了解这些技术手段。
接下来的几节内容将介绍文档数据库的基本工作原理和最重要的技术手段。本节首先介绍数据是如何被存储在系统中的，以及数据存取功能是如何实现的。

## 计算机的数据存储体系

计算机的数据存储体系是一个金字塔结构。下图展示了传统计算机的存储层次结构。最上层CPU里面的寄存器，是CPU中的计算单元直接获取数据的地方。接下来是缓存，用于加速CPU对内存的访问。再下面依此为内存（DRAM）、磁盘（Disk）和离线存储（通常为磁带）。这个存储层次结构有一个显著特点，即越上层的设备存取速度越快，但单位容量的价格越贵。相应的，越下面的设备存取速度约慢，但单位容量的价格约便宜。

![storage_hierarchy](https://i.pinimg.com/originals/55/71/33/55713334e2109df8fdf635edf511ad23.png)

以其中的内存和磁盘为例，内存的访问延时为100ns（ns为纳秒），而磁盘的访问延时为10ms（ms为毫秒），二者相差近10万倍。但内存比磁盘贵多了，价格差不多是磁盘的200倍。当我们需要保存数据时，我们希望使用磁盘，因为用磁盘保存数据的成本更低。当我们需要访问数据时，我们又希望数据存放在内存中，因为这样的访问效率更高。为了结合二者的优点，我们可以将它们组合起来，形成一个双层结构。这样，数据可以在廉价的磁盘中保存，而经常被访问的热数据又可以暂存在内存中，以提高访问效率。由此可见，上图呈现的金字塔结构是一种能够兼顾存储成本和访问效率的合理结构。随着硬件科技的发展，新的存储硬件将不断涌现出来，比如最近几年已经相当普及的固态硬盘（Solid State Drive），以及刚问市的非易失内存（Non-Volatile Memory）。但无论存储硬件如何改变，这种金字塔型的存储体系却注定不会改变，因为将昂贵但速度快的硬件和廉价但速度慢的硬件很难彼此取代，配合起来使用却能得到更高的性价比。

我们在构建数据库系统时，常常需要考虑到这种层次存储结构的特性，尽力做到物尽其用。这个理念将在本书设计的很多技术环节中都会有所体现。

## 文档是如何被存储的

数据库系统的首要责任是妥善保存数据。在上述的数据存储体系中，全量的数据会被存放于最底层的存储设备，通常情况下为磁盘或者固态硬盘（以下统称为硬盘）。离线存储由于访问速度过慢，通常只用于备份数据，只在磁盘或固态硬盘损坏时才派上用场。而更上层的内存由于价格昂贵，通常只用于暂存被经常访问的热数据。内存掉电后会丢失数据，这也导致它不适合用于长期存储数据。

那么，对文档数据库而言，一个个的文档是如何被存储在硬盘中的呢？文档的大小不是固定的。小的文档可能只占十几个字节（Byte）。大的文档可能有数KB甚至达到数MB。而且用户随时都可能访问文档，对它们进行修改，改变它们的大小。我们需要将众多的文档规整的放置在一个连续的存储空间内，既不浪费空间，又便于管理。为了达到这些要求，我们需要一个好的数据存储结构。

为了实现文档的存储，最简单的方式是将文档逐个依次写入到硬盘空间。但这种看似简单的方式为磁盘空间的管理带来了麻烦。如果文档被紧挨着存放，文档的修改就会遇到困难。如果修改后的文档长度增加，原有的空间就无法容纳，迫使系统划拨新的空间存放文档。文档的删除或位置移动会在原有空间上形成空洞。空洞不仅造成空间浪费，还会导致系统的性能低下。时间长了，整个存储空间就需要重新整理，去除空洞。整理过程耗时耗力，又会导致系统性能不稳定。这就像我们在衣柜里堆满了衣帽鞋袜，使用一段时间后就需要重新整理一遍，否则衣柜的使用效率就会变得低下。

对一个衣柜而言，直接将衣物堆在里面是低效的。合理的方式是使用收纳箱，衣物放在各个收纳箱里，独立管理，而所有的收纳箱可以整理地放在衣柜里。这样让衣柜既整洁又便于使用。存储系统可以采用同样的思路，将存储空间划分成数据块（Block或Page），将文档放置在数据块中，让每一块的存储空间可以独立管理。当文档需要增加长度时，我们只需要整理它所在的那一个数据块的空间，而无需涉及其他的块。系统在分配和回收存储空间时，只需要分配和回收数据块就可以了，空间管理工作因而被简化。

![page structure](http://sqlbak.com/academy/wp-content/uploads/2015/11/Page-structure.png)

上图刻画了一个数据块的空间布局。数据块的头部称为“页头”，记录了数据块的基本信息，包括里面存有多少文档、还有多少空闲空间等。数据块的尾部是一个指针列表，每一个指针指向各个文档在数据块中的位置。当我们要访问一个文档时，我们先通过系统找到文档所在的数据块，将数据块从硬盘调入到内存中，然后再通过程序找到文档并对文档进行处理。在文档数据库中有文档集的概念。一个数据块通常只归属于一个文档集。系统在它的元数据中记录了每个文档集的所有数据块的位置。当访问一个文档集的时候，我们可以通过元数据定位到它的所有数据块，然后就可以访问到文档集中的任意一个文档。

## 习题

1. 假设给你一个由磁盘和内存组成的存储体系和一笔钱，你可以用这笔钱去购买更多的内存或者磁盘去扩展这个存储体系的容量。如果一份数据每10秒钟就会被访问一次，你会选择把它放在内存里还是磁盘里？如果它每隔1个小时才被访问一次呢？如果每隔2分钟被访问一次呢？为什么？

2. 请解释：为什么存储体系会呈金字塔结构（顶层的容量比底层的容量大）？什么情形下我们才不再需要这样的金字塔结构？
